import{r as e,j as s,L as t,u as r}from"./index-dWbV2YWN.js";import{O as o,T as a,y as l}from"./endpoints-C8SDwtyd.js";import{B as n}from"./button-BYsJFizr.js";import{u as i,e as c}from"./copytoclipboard-Cy7DO2po.js";import{g as d,t as u,h as m}from"./table_util-DcgUt5Gf.js";import{u as h}from"./useSuspenseQuery-C4hISphF.js";import{G as p,D as b}from"./DataTable-BzuxNtBf.js";import{a as f}from"./StateUtil-moXfkR8g.js";import{L as g}from"./loading-DZKuFaBE.js";function j({getTableProps:t,load:r}){const o=e.useRef(null),{showDialog:a}=i(),[l,c]=f(r?t().type:null),[u,m]=f(r?t().selection:{}),[h,g]=f(r?t().columns:new Map),[j,y]=f(r?t().sort:void 0),w=e.useCallback((()=>{const e=t();return c(e.type),m(e.selection),g(e.columns),y(e.sort),e}),[t,c,m,g,y]),S=e.useCallback(((e,s)=>{var t;const r=null==(t=o.current)?void 0:t.element,a=(null==r?void 0:r.querySelectorAll(".bg-red-500"))||[];for(const o of a)o.classList.remove("bg-red-500")}),[o]),C=e.useCallback((()=>{const e=`${window.location.protocol+"//"+window.location.host}/#/view_table?${encodeURIComponent(d({type:l,selAndModifiers:u,columns:h,sort:j}))}`;navigator.clipboard.writeText(e).then((()=>{a("URL copied to clipboard",e,!0)})).catch((e=>{a("Failed to copy URL to clipboard",e+"",!0)}))}),[l,u,h,j,a]),k=e.useMemo((()=>l&&u&&h?s.jsx(p,{type:l,selection:u,columns:h}):null),[l,u,h]),N=e.useMemo((()=>s.jsx(n,{variant:"outline",size:"sm",onClick:C,children:"Share"})),[C]),E=e.useCallback((e=>{const s=parseInt(e.currentTarget.dataset.col??"0")-1,t=parseInt(e.currentTarget.dataset.row??"0")-1;S(s,t)}),[S]),M=e.useCallback((e=>{const t=e.length>0?"Errors updating table":"No errors",r=e.length>0?s.jsxs(s.Fragment,{children:["Errors updating the table may prevent some data from being displayed. Click the buttons below to highlight the errors in the table.",e.map(((e,t)=>s.jsxs(n,{"data-col":e.col,"data-row":e.row,variant:"destructive",className:"my-1 h-auto break-words w-full justify-start size-sm whitespace-normal",onClick:E,children:["[col:",(e.col??0)+1,e.row?`row:${e.row+1}`:"","] ",e.msg]},t)))]}):"No errors";a(t,r)}),[a,E]),T=e.useCallback(((e,t,r,a,l,n,i)=>s.jsxs(s.Fragment,{children:[k,N,e,s.jsx(b,{table:o,data:t,columnsInfo:r,sort:j,searchSet:a,visibleColumns:l,showExports:!0,setColumns:n,setData:i,setSort:y})]})),[k,N,j,y]);return r?s.jsx(v,{type:l,selection:u,columns:h,sort:j,showErrorsProvided:M,children:T}):s.jsx(x,{table:o,getTableProps:w,setSortState:y,showErrorsProvided:M,children:T})}function v({type:r,selection:l,columns:c,sort:p,showErrorsProvided:b,children:f}){const{showDialog:g}=i(),j=e.useMemo((()=>({...o(a.endpoint,{type:r,selection_str:u(l),columns:Array.from(c.keys())},void 0,10),enabled:!1})),[r,l,c]),{data:v}=h(j),[x,y]=e.useState([]),[w,S]=e.useState(new Set),C=v.data,k=e.useMemo((()=>{try{return m(C,p,c)}catch(e){return}}),[p,c,C]),[N,E]=e.useState(null==k?void 0:k.data),[M,T]=e.useState((null==k?void 0:k.columnsInfo)||[]),[z,F]=e.useState((null==k?void 0:k.errors)||[]);if(v.error)return s.jsxs("div",{className:"text-red-500",children:["Error: ",v.error]});if(!v.data)return s.jsx("div",{className:"text-red-500",children:"No data"});if(!k)return s.jsx("div",{className:"text-red-500",children:"Error: No data"});const I=e.useCallback((()=>{z.length>0?b(z):g("No errors","No errors to display",!0)}),[z,b,g]),P=e.useMemo((()=>`/custom_table?${d({type:r,selAndModifiers:l,columns:c,sort:p})}`),[r,l,c,p]),A=e.useMemo((()=>s.jsxs(n,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==z.length?"hidden":""),onClick:I,children:["View ",z.length," Errors"]})),[z.length,I]);return s.jsxs(s.Fragment,{children:[s.jsx(n,{variant:"outline",size:"sm",className:"me-1",asChild:!0,children:s.jsx(t,{to:P,children:"Edit Table"})}),f(A,N,M,w,x,T,E)]})}function x({table:t,getTableProps:o,setSortState:d,showErrorsProvided:h,children:p}){const{showDialog:b}=i(),f=r(),[j,v]=e.useState([]),[x,y]=e.useState([]),[w,S]=e.useState(new Set),[C,k]=e.useState([]),[N,E]=e.useState([]),[M,T]=e.useState(!1),z=e.useCallback((()=>{N.length>0?h(N):b("No errors","No errors to display",!0)}),[N,h,b]),F=e.useCallback((e=>{v(e.data),k(e.columnsInfo),y(e.visibleColumns),S(e.searchSet),E(e.errors),d(e.sort)}),[v,k,y,S,E,d]),I=e.useMemo((()=>s.jsxs(n,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==N.length?"hidden":""),onClick:z,children:["View ",N.length," Errors"]})),[N.length,z]),P=e.useCallback((e=>{const t=e instanceof Error?s.jsxs(s.Fragment,{children:[e.message,s.jsx(c,{text:e.stack+""})]}):e+"";b("Failed to update table",t,!0)}),[b]),A=e.useCallback(((e,s,t)=>{try{const r=m(e,s,t);F(r)}catch(r){P(r)}}),[F,P]),D=e.useCallback((()=>{const{type:e,selection:s,columns:t,sort:r}=o(),n={type:e,selection_str:u(s),columns:Array.from(t.keys())};T(!0),f.fetchQuery(l(a.endpoint,n,0)).then((({data:e})=>{e?A(e,r,t):P("No data returned from server")})).catch((e=>{P(e)})).finally((()=>{T(!1)}))}),[o,A,f,P]),L="Generate Table",_=e.useMemo((()=>s.jsx(n,{variant:"destructive",size:"sm",className:"me-1 relative",onClick:D,disabled:M,children:s.jsxs("span",{className:"flex items-center justify-center w-full",children:[s.jsx("span",{className:M?"invisible":"visible",children:L}),M&&s.jsx("span",{className:"absolute inset-0 flex items-center justify-center",children:s.jsx(g,{size:3,variant:"ripple"})})]})})),[M,D,L]);return s.jsxs(s.Fragment,{children:[_,p(I,j,C,w,x,k,v)]})}export{j as A};
